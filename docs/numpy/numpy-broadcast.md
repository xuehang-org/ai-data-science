---
title: NumPy 广播
---

# 11. NumPy 广播

## 11.1 什么是广播？

广播是指 NumPy 在算术运算期间处理形状不同的数组的能力。当运算中的数组形状不完全相同时，NumPy 会自动尝试通过扩展数组来使它们的形状兼容。 这种扩展数组的方式就叫做广播。

简单来说，广播机制的核心思想是： NumPy 会自动“扩展”维度较小的数组，使其与维度较大的数组的形状相匹配，这样才能进行元素级别的运算。

## 11.2 广播的规则

NumPy 的广播遵循一套严格的规则，以确定两个数组是否可以进行广播。 总结如下：

1.  **维度对齐：** 从**尾部维度**开始比较，即最右边的维度开始。
2.  **兼容条件：** 两个维度满足下列条件之一，则它们是兼容的：
    *   维度大小相等。
    *   其中一个维度大小为 1。
3.  **广播结果：** 如果输入数组的所有维度都兼容，则可以进行广播。广播后的数组的每个维度的大小将是输入数组在该维度上的最大大小。

如果这些规则不满足，NumPy 将抛出一个 `ValueError`，表明数组的形状不兼容。

## 11.3 广播的例子

### 11.3.1 标量和数组相加

这是最简单的广播形式。将一个标量值加到一个数组上，相当于将这个标量扩展成与数组相同的形状，然后进行加法运算。

```python
import numpy as np

a = np.array([1, 2, 3])
b = 2  # 标量

result = a + b
print(result)  # 输出: [3 4 5]
```

在这个例子中，标量 `b` 被广播成了 `[2, 2, 2]`，然后与 `a` 相加。

### 11.3.2 一维数组和二维数组相加

当一个一维数组和一个二维数组进行运算时，NumPy 会尝试将一维数组广播到二维数组的每一行。

```python
import numpy as np

a = np.array([[1, 2, 3],
              [4, 5, 6]])  # (2, 3)
b = np.array([10, 20, 30])  # (3,)

result = a + b
print(result)
# 输出:
# [[11 22 33]
#  [14 25 36]]
```

在这里，一维数组 `b` 被广播成了：

```
[[10 20 30]
 [10 20 30]]
```

然后与 `a` 相加。

### 11.3.3 不同形状的二维数组相加

```python
import numpy as np

a = np.array([[1, 2, 3],
              [4, 5, 6]])  # (2, 3)
b = np.array([[10],
              [20]])  # (2, 1)

result = a + b
print(result)
# 输出:
# [[11 12 13]
#  [24 25 26]]
```

在这个例子中，`a` 的形状是 `(2, 3)`，`b` 的形状是 `(2, 1)`。 NumPy 会将 `b` 广播成：

```
[[10 10 10]
 [20 20 20]]
```

然后与 `a` 相加。

### 11.3.4 无法广播的情况

如果数组的形状不满足广播规则，NumPy 会抛出错误。

```python
import numpy as np

a = np.array([[1, 2, 3],
              [4, 5, 6]])  # (2, 3)
b = np.array([10, 20])  # (2,)

try:
    result = a + b
    print(result)
except ValueError as e:
    print(e)  # 输出: operands could not be broadcast together with shapes (2,3) (2,)
```

这里 `a` 的形状是 `(2, 3)`，`b` 的形状是 `(2,)`。由于它们的维度不兼容，NumPy 无法进行广播，会抛出 `ValueError`。

## 11.4 广播的实际应用

广播在实际数据分析和科学计算中非常有用。例如，在数据标准化时，我们经常需要从每个数据点中减去均值。

```python
import numpy as np

data = np.array([[1, 2, 3],
                 [4, 5, 6],
                 [7, 8, 9]])  # (3, 3)

mean = np.mean(data, axis=0)  # 计算每一列的均值，结果是 (3,)
print("每一列的均值", mean)

standardized_data = data - mean  # 广播
print(standardized_data)
# 输出:
# [[-2.  -2.  -2.]
#  [ 0.  0.  0.]
#  [ 2.  2.  2.]]
```

在这个例子中，我们计算了 `data` 中每一列的均值，然后使用广播将这个均值从原始数据中减去，实现了数据的标准化。

## 11.5 总结

NumPy 的广播机制是一种强大的工具，可以简化数组运算的代码。通过理解广播的规则，我们可以更有效地利用 NumPy 进行数据处理和科学计算。希望这些例子能帮助你更好地理解 NumPy 的广播概念。